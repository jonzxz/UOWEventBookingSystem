{% extends "base.html" %}

{% block content %}
<div class="container main-container ml-2 top-margin">
	<form action="" method="post">
		{{ form.hidden_tag() }}

		<!-- Event title -->
		<div class="row mb-2">
			<div class="col-md-1">
				{{ form.title.label }}
			</div>
			<div class="col-md-8">
				{{ form.title() }}
			</div>
		</div>

		<!-- Username -->
		<div class="row mb-2">
			<div class="col-md-1">
				{{ form.username.label }}
			</div>
			<div class="col-md-8">
				{{ form.username() }}
			</div>
		</div>

		<!-- Date and Time -->
		<div class="row mb-2">
			<div class="col-md-1">
				Slot
				</div>
			<div class="col-md-1" style="padding-left:5.5%;">
				{{ form.date.label }}
			</div>
			<div class="col-md-1" style="margin-left:7.3%;">
				{{ form.time.label }}
			</div>

		</div>
		<div class="row mb-2">
		<div class="col-md-2" style="margin-left:8.4%; margin-right:-3.9%;">
			{{ form.date(size=1, class_='custom-select', style='width:80%;') }}
		</div>
		<div class="col-md-2"">
			{{ form.time(size=1, class_='custom-select', style='width:65%;') }}
		</div>
		</div>

		<!-- Vacancy -->
		<div class="row mb-2">
			<div class="col-md-1">
				Available Seats:
			</div>
			<div class="col-md-8">
				{{ form.vacancy() }}
			</div>
		</div>

		<!-- No. of Tickets -->
		<div class="row mb-2">
			<div class="col-md-1">
				Tickets
			</div>
			<div class="col-md-8">
			  	{{ form.count(onchange="refreshPrice()", max=form.vacancy.data) }}
				<!-- {{ form.count(onchange="refreshPrice()", max=capacity, onkeydown="return false") }} -->
				{% for error in form.count.errors %}
				<span style="color: red;">[{{ error }}]</span>
				{% endfor %}
			</div>
		</div>

		<!-- Total Cost -->
		<div class="row mb-2">
			 <div class="col-md-1">
			   Total ($)
			 </div>
			 <div class="col-md-8">
			   {{ form.price() }}
			   <script>var basePrice = document.getElementById('price').value</script>
			 </div>
		</div>

		<!-- Book Button -->
		<div class="row">
			<div class="col offset-1">
			  {{ form.submit(class="btn btn-primary",
			 				 style="width:24.5%;") }}
			</div>
		</div>
	</form>
</div>

<!-- Dynamic updates -->
<script>
function refreshPrice(){
    document.getElementById('price').value =
		parseFloat(document.getElementById('count').value * basePrice).toFixed(2)
}
</script>

<!-- Dynamically update available times based on date selected -->
<script>
  let date_select = document.getElementById('date');
  let time_select = document.getElementById('time');

  // Update available times and vacancy based on date selected
  date_select.onchange = function() {
	  date = date_select.value;

	  fetch('/booking/' + {{ eid }} + '/' + date).then(function(response) {
		  response.json().then(function(data) {
			  let time_choices_HTML = '';
			  let count = 0;

			  for (let timing of data.timings) {
				  time_choices_HTML += '<option value="' + timing.slot_id
										+ '">' + timing.time + '</option>';
				  if (count == 0) {
					  document.getElementById('vacancy').value = timing.vacancy;
					  document.getElementById('count').max = timing.vacancy;
				  }
				  ++count;
			  }

			  time_select.innerHTML = time_choices_HTML;
		  });
	  });
  }

  // Update vacancy based on time selected
  time_select.onchange = function() {
	  sid = time_select.value;
	  fetch('/booking/vacancy/' + sid).then(function(response) {
		  response.json().then(function(data) {
			  document.getElementById('vacancy').value = data.vacancy;
			  document.getElementById('count').max = data.vacancy;
		  });
	  });
  }
</script>

{% endblock %}
