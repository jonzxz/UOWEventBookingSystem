{% extends "base.html" %}

{% block content %}
<h1>List of booked events for this user</h1>

<table>
{% for b in bookings  %}
<tr>
  <td><b>Event:</b> {{ b.title }}</td>
  <td><b>Date:</b> {{ b.date }}</td>
  <td><b>Time:</b> {{ b.time }}</td>
  <td>
	<b>Available Seats:</b>
	<span id="v{{b.id}}">{{ b.vacancy }}</span>
  </td>
  <td>
	<b>Tickets:</b>	<span id="c{{b.id}}">{{ b.qty }}</span>
  </td>

  <!-- Ticket quantity change -->
  <td>
	<form action="javascript:void(0)">
	  <b>Edit Qty</b>
	  Â±<input id={{b.id}} type="number"
			  value="0" min=-{{b.qty}} max={{b.vacancy}}
			  style="width: 75px; height: 40px;"
			  onchange="update(this.id, this.value)">
	  </input>
	</form>
  </td>

  <!-- Update button -->
  <td>
	<a id="btn{{b.id}}" href="#"
	   class="btn btn-primary"
	   style="opacity: 0.5">
	  update
	</a>
  </td>
</tr>
{% endfor %}
</table>

<script>
  function update(change_id, change_qty) {
	  let current_qty = document.getElementById(`c${change_id}`).innerHTML;
	  let vacant_qty = document.getElementById(`v${change_id}`).innerHTML;
	  let update_button = document.getElementById(`btn${change_id}`);
	  let run_check = `return check_qty(${change_qty}, ${current_qty}, ${vacant_qty})`;

	  if (change_qty > 0) {
		  update_button.setAttribute("href", "/my_bookings/edit/" + change_id);
		  update_button.setAttribute("style", "opacity: 1");
		  update_button.setAttribute("onclick", run_check);
	  } else if (change_qty < 0) {
		  update_button.setAttribute("href", "/my_bookings/edit/" + change_id);
		  update_button.setAttribute("style", "opacity: 1");
		  update_button.setAttribute("onclick", run_check);
	  } else {
		  update_button.setAttribute("href", "#");
		  update_button.setAttribute("style", "opacity: 0.5");
		  update_button.setAttribute("onclick", "");
	  }
  }
</script>

<script>
  function check_qty(change_qty, current_qty, vacant_qty) {
	  if (change_qty < 0 && Math.abs(change_qty) > current_qty) {
		  alert("Cannot return more number of tickets booked.");
		  return false;
	  } else if (change_qty > 0 && change_qty > vacant_qty) {
		  alert("Cannot add more than available seats.");
		  return false;
	  } else {
		  return confirm('confirm update');
	  }
  }
</script>
{% endblock %}
